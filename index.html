<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Camera Stream</title>
  <style>
    body { background:#111; color:#fff; display:flex; flex-direction:column; align-items:center; font-family:Arial; }
    video { width:80%; max-width:640px; margin:10px; background:#000; border-radius:12px; }
    #roleOverlay, #consentOverlay {
      position:fixed; inset:0; background:rgba(0,0,0,0.8);
      display:flex; align-items:center; justify-content:center;
    }
    .box { background:#222; padding:20px; border-radius:12px; text-align:center; max-width:300px; }
    button { padding:10px 20px; margin:10px; border:none; border-radius:8px; font-size:16px; cursor:pointer; }
    button.ghost { background:transparent; border:1px solid #666; color:#fff; }
  </style>
</head>
<body>
  <h2>Camera Livestream</h2>
  <video id="video" autoplay playsinline controls></video>

  <!-- Bước 1: yêu cầu quyền -->
  <div id="consentOverlay">
    <div class="box">
      <h3>Yêu cầu quyền truy cập Camera</h3>
      <p>Trang web cần quyền để phát hình.</p>
      <button id="acceptBtn">Đồng ý</button>
      <button id="declineBtn" class="ghost">Từ chối</button>
    </div>
  </div>

  <!-- Bước 2: chọn role -->
  <div id="roleOverlay" style="display:none;">
    <div class="box">
      <h3>Bạn muốn?</h3>
      <button id="broadcasterBtn">Phát Camera</button>
      <button id="viewerBtn">Xem Livestream</button>
    </div>
  </div>

  <script>
    const signalingUrl = "wss://4b5c7241-830e-4eb0-8d23-83e4911c06d2-00-2nij1hw6romg6.kirk.replit.dev";
    const video = document.getElementById("video");
    const roleOverlay = document.getElementById("roleOverlay");
    const consentOverlay = document.getElementById("consentOverlay");
    let pc, ws, localStream;

    // --- Consent step ---
    document.getElementById("acceptBtn").onclick = async () => {
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
        consentOverlay.style.display = "none";
        roleOverlay.style.display = "flex";
      } catch (err) {
        alert("Không thể truy cập camera: " + err.message);
      }
    };
    document.getElementById("declineBtn").onclick = () => {
      consentOverlay.querySelector(".box").innerHTML = "<p>Bạn đã từ chối quyền camera.</p>";
    };

    function initWS(role) {
      ws = new WebSocket(signalingUrl);
      ws.onmessage = async (msg) => {
        const data = JSON.parse(msg.data);
        if (data.sdp) {
          await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
          if (data.sdp.type === "offer") {
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            ws.send(JSON.stringify({ type: role, sdp: pc.localDescription }));
          }
        }
        if (data.candidate) {
          try { await pc.addIceCandidate(new RTCIceCandidate(data.candidate)); } catch(e){}
        }
      };
    }

    async function startBroadcaster() {
      roleOverlay.style.display="none";
      pc = new RTCPeerConnection();
      video.srcObject = localStream;
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

      initWS("broadcaster");

      pc.onicecandidate = (e) => {
        if (e.candidate) ws.send(JSON.stringify({ type:"broadcaster", candidate:e.candidate }));
      };

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      ws.onopen = () => {
        ws.send(JSON.stringify({ type:"broadcaster", sdp: pc.localDescription }));
      };
    }

    async function startViewer() {
      roleOverlay.style.display="none";
      pc = new RTCPeerConnection();

      pc.ontrack = (e) => { video.srcObject = e.streams[0]; };

      initWS("viewer");

      pc.onicecandidate = (e) => {
        if (e.candidate) ws.send(JSON.stringify({ type:"viewer", candidate:e.candidate }));
      };
    }

    document.getElementById("broadcasterBtn").onclick = startBroadcaster;
    document.getElementById("viewerBtn").onclick = startViewer;
  </script>
</body>
</html>
